<script>
  Telegram.WebApp.ready(); Telegram.WebApp.expand();

  // === API ===
  const API = 'http://localhost:8080';
  let token = null;

  async function api(path, opts={}) {
    const r = await fetch(API+path, {
      method: opts.method || 'GET',
      headers: {'Content-Type':'application/json', ...(token ? {Authorization:'Bearer '+token}: {})},
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if (!r.ok) { let msg = await r.text(); try { msg = JSON.parse(msg).error || msg } catch {}; throw new Error(msg); }
    return r.json();
  }

  async function auth() {
    const initData = Telegram.WebApp.initData || '';
    const r = await api('/auth/telegram', { method:'POST', body:{ initData } });
    token = r.token;
    await refreshProfile();
  }

  async function refreshProfile() {
    const me = await api('/me');
    totalPoints = Number(me.total_points||0);
    updateUI();
  }

  // === Игра ===
  const MAX_PER_RUN = 30000, TICK_POINTS = 5, TICK_MS = 300;
  let totalPoints = 0, runPoints = 0, running = false, paused = false, timer = null, runId = null;
  let audioOn = false, ac = null;

  const totalEl=document.getElementById('tot'), runEl=document.getElementById('run'),
        statusEl=document.getElementById('status'), pauseBtn=document.getElementById('pauseBtn'),
        endBtn=document.getElementById('endBtn'), soundBtn=document.getElementById('soundBtn'),
        overlay=document.getElementById('overlay');

  function updateUI(){
    totalEl.textContent="Всего очков: "+totalPoints;
    runEl.textContent="Очки за забег: "+runPoints;
    statusEl.textContent="Статус: "+(running?(paused?"пауза":"бег"):"ожидание старта");
    pauseBtn.textContent=paused?"Продолжить":"Пауза";
    pauseBtn.disabled=!running; endBtn.disabled=!running;
    soundBtn.textContent="Звук: "+(audioOn?"вкл":"выкл");
  }

  async function startRun(){
    if(running) return;
    const r = await api('/runs/start', {method:'POST', body:{}});
    runId = r.runId;
    running=true; paused=false; runPoints=0; timer=setInterval(tick,TICK_MS);
    beep(300,0.05); updateUI();
  }

  function tick(){
    if(!running||paused) return;
    if(runPoints>=MAX_PER_RUN){ endRun(); return; }
    const add=Math.min(TICK_POINTS, MAX_PER_RUN-runPoints);
    runPoints+=add; if(audioOn) beep(880,0.01); updateUI();
  }

  async function endRun(){
    if(!running) return;
    clearInterval(timer); timer=null; running=false;
    const r = await api('/runs/end', {method:'POST', body:{ runId, points: runPoints }});
    const accepted=Number(r.acceptedPoints||0);
    totalPoints+=accepted; if(audioOn) beep(520,0.05); updateUI();
    alert("Забег завершён. Зачтено очков: "+accepted);
  }

  function togglePause(){ if(!running) return; paused=!paused; if(audioOn) beep(paused?420:660,0.03); updateUI(); }
  function toggleSound(){ audioOn=!audioOn; if(audioOn&&!ac) ac=new (window.AudioContext||window.webkitAudioContext)(); if(audioOn) beep(700,0.03); updateUI(); }
  function beep(freq,dur){ if(!audioOn) return; try{ if(!ac) ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(), g=ac.createGain(); o.connect(g); g.connect(ac.destination); o.type='square'; o.frequency.value=freq; g.gain.setValueAtTime(0.04,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.0001,ac.currentTime+dur); o.start(); o.stop(ac.currentTime+dur);}catch{} }

  // === Меню ===
  function showMenu(){ overlay.style.display='flex'; }
  function hideMenu(){ overlay.style.display='none'; }
  function closeMenu(e){ if(e.target===overlay) hideMenu(); }
  function copyRef(){ navigator.clipboard.writeText('https://t.me/your_bot?start=DEMO_CODE'); alert('Ссылка скопирована'); }

  async function demoExchange(){
    const p = prompt('Сколько очков обменять?'); const pts = Math.max(0, parseInt(p||'0',10)||0); if(!pts) return;
    try{
      const prev = await api('/exchange/preview?points='+pts);
      const coins = BigInt(prev.coins||'0'); const used = BigInt(prev.pointsUsed||'0');
      if(coins===0n){ alert('Недостаточно очков для обмена'); return; }
      if(!confirm(`Предпросмотр:\nОчки: ${used}\nМонет: ${coins}\nПродолжаем?`)) return;
      const idem='idem_'+Date.now()+'_'+Math.random().toString(36).slice(2);
      const res = await api('/exchange', {method:'POST', body:{ points: pts, idempotencyKey: idem }});
      alert(`Выпущено монет: ${res.coinsIssued}\nСписано очков: ${res.pointsSpent}`);
      await refreshProfile();
    }catch(e){ alert('Ошибка обмена: '+(e.message||e)); }
  }

  document.getElementById('menuBtn').addEventListener('click', showMenu);
  soundBtn.addEventListener('click', toggleSound);

  updateUI();
  auth(); // важный шаг: получаем token
</script>
