<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dino Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; gap:10px }
    h1 { margin:0 0 10px }
    .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center }
    button { padding:10px 16px; font-size:16px }
    .stat { font-size:18px }
  </style>
</head>
<body>
  <h1>Dino Mini App</h1>

  <div class="stat" id="total">Всего очков: 0</div>
  <div class="stat" id="run">Очки за забег: 0</div>
  <div class="stat" id="status">Статус: ожидание старта</div>

  <div class="row">
    <button onclick="startRun()">Старт забега</button>
    <button onclick="togglePause()" id="pauseBtn" disabled>Пауза</button>
    <button onclick="endRun()" id="endBtn" disabled>Завершить забег</button>
  </div>

  <button onclick="window.Telegram.WebApp.close()">Закрыть</button>

  <script>
    Telegram.WebApp.ready(); Telegram.WebApp.expand();

    // Константы
    const MAX_PER_RUN = 30000;   // лимит по ТЗ
    const TICK_POINTS = 5;       // очков за тик
    const TICK_MS = 300;         // раз в 300 мс

    // Состояние
    let totalPoints = 0;   // сумма за все забеги
    let runPoints = 0;     // очки текущего забега
    let running = false;
    let paused = false;
    let timer = null;

    // UI
    const totalEl = document.getElementById('total');
    const runEl   = document.getElementById('run');
    const statusEl= document.getElementById('status');
    const pauseBtn= document.getElementById('pauseBtn');
    const endBtn  = document.getElementById('endBtn');

    function updateUI() {
      totalEl.textContent = "Всего очков: " + totalPoints;
      runEl.textContent = "Очки за забег: " + runPoints;
      statusEl.textContent = "Статус: " + (running ? (paused ? "пауза" : "бег") : "ожидание старта");
      pauseBtn.textContent = paused ? "Продолжить" : "Пауза";
      pauseBtn.disabled = !running;
      endBtn.disabled = !running;
    }

    function startRun() {
      if (running) return;
      running = true;
      paused = false;
      runPoints = 0;
      timer = setInterval(tick, TICK_MS);
      updateUI();
    }

    function tick() {
      if (!running || paused) return;
      if (runPoints >= MAX_PER_RUN) {
        endRun(); // автозавершение по лимиту
        return;
      }
      const canAdd = Math.min(TICK_POINTS, MAX_PER_RUN - runPoints);
      runPoints += canAdd;
      updateUI();
    }

    function togglePause() {
      if (!running) return;
      paused = !paused;
      updateUI();
    }

    function endRun() {
      if (!running) return;
      clearInterval(timer); timer = null;
      running = false;

      // Фиксируем очки забега к общим
      totalPoints += runPoints;
      updateUI();

      alert("Забег завершён. Получено очков: " + runPoints);
    }

    updateUI();
  </script>
</body>
</html>
